<!DOCTYPE html>
<html lang="fr" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bibliothèque de végétaux</title>
  <style>
    :root{
      --gap:20px;
      --radius:8px;
      --shadow:0 2px 6px rgba(0,0,0,.1);
    }
    *{box-sizing:border-box}
    body{font-family: Arial, sans-serif;background:#f8f8f8;margin:0}
    header{padding:20px;text-align:center}
    h1{margin:0}
    #controls{display:flex;gap:10px;justify-content:center;align-items:center;padding:0 20px 10px;flex-wrap:wrap}
    #search{padding:8px 10px;width:280px;max-width:90vw}
    #controls button{padding:8px 12px;border:1px solid #000;background:#fff;cursor:pointer;border-radius:6px}
    #controls button:hover{background:#eee}
    #error{color:#c00;text-align:center;margin:10px 20px}
    #gallery{display:grid;gap:var(--gap);padding:20px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:10px;text-align:center;display:flex;flex-direction:column;gap:8px}
    .card img{width:100%;height:180px;object-fit:cover;border-radius:6px}
    .title{font-weight:600;min-height:2.2em}
    .btnrow{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .btnrow button{padding:6px 10px;border:1px solid #000;background:#fff;cursor:pointer;border-radius:6px}
    .btnrow button:hover{background:#eee}
  </style>

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:_dlc_DocId msdt:dt="string">MAD7RP7FRE63-159287787-1472837</mso:_dlc_DocId>
<mso:_dlc_DocIdItemGuid msdt:dt="string">bd9f519a-c6df-42fe-bf74-6be4371d04bb</mso:_dlc_DocIdItemGuid>
<mso:_dlc_DocIdUrl msdt:dt="string">https://groupelajus.sharepoint.com/sites/A.O/_layouts/15/DocIdRedir.aspx?ID=MAD7RP7FRE63-159287787-1472837, MAD7RP7FRE63-159287787-1472837</mso:_dlc_DocIdUrl>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>
<body>
  <header><h1>Bibliothèque de végétaux</h1></header>

  <div id="controls">
    <input id="search" type="text" placeholder="Rechercher..." />
    <button id="refresh">Actualiser</button>
    <button id="reset">Réinitialiser</button>
  </div>

  <div id="error"></div>
  <div id="gallery"></div>

  <script>
    let PHOTOS = [];

    // --- utilitaire : normaliser le texte (sans accents/ponctuation, en minuscule)
    const normalize = (s='') =>
      s.toString()
       .normalize('NFD')
       .replace(/[\u0300-\u036f]/g, '')    // accents
       .replace(/\.[^.]+$/,'')             // extension fichier (.jpg,.jpeg,.png…)
       .replace(/[^a-z0-9\s-]/gi,' ')      // ponctuation -> espace
       .replace(/\s+/g,' ')                // espaces multiples
       .trim()
       .toLowerCase();

    async function loadPhotos() {
      const errorEl = document.getElementById('error');
      const gallery = document.getElementById('gallery');
      errorEl.textContent = '';
      gallery.innerHTML = 'Chargement...';

      try {
        const res = await fetch('photos.json?nocache=' + Date.now());
        if (!res.ok) throw new Error('Impossible de charger la liste');
        PHOTOS = await res.json();

        // Prépare une clé de recherche normalisée pour chaque item (fait une seule fois)
        for (const p of PHOTOS) p._key = normalize(p.name);

        render();
      } catch (e) {
        errorEl.textContent = 'Erreur : ' + e.message;
        gallery.innerHTML = '';
      }
    }

    function render() {
      const qRaw = document.getElementById('search').value;
      const q = normalize(qRaw);
      const tokens = q.length ? q.split(' ') : [];

      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';

      const list = tokens.length
        ? PHOTOS.filter(p => tokens.every(t => p._key.includes(t)))
        : PHOTOS;

      for (const p of list) {
        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('img');
        img.src = p.url;
        img.alt = p.name;

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = p.name.replace(/\.[^/.]+$/, '');

        const row = document.createElement('div');
        row.className = 'btnrow';

        const openBtn = document.createElement('button');
        openBtn.textContent = 'Ouvrir';
        openBtn.addEventListener('click', () => window.open(p.url, '_blank'));

        const dlBtn = document.createElement('button');
        dlBtn.textContent = 'Télécharger';
        dlBtn.addEventListener('click', (e) => {
          e.preventDefault();
          downloadFile(p.url, p.name);
        });

        row.appendChild(openBtn);
        row.appendChild(dlBtn);

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(row);
        gallery.appendChild(card);
      }

      if (list.length === 0) {
        gallery.innerHTML = "<p style='grid-column:1 / -1; text-align:center'>Aucun résultat</p>";
      }
    }

    // Téléchargement (fetch → blob) + repli lien direct
    async function downloadFile(url, filename) {
      try {
        const res = await fetch(url, { mode: 'cors', cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = objectUrl;
        a.download = filename || 'fichier';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(objectUrl);
      } catch (err) {
        const a = document.createElement('a');
        a.href = url;
        a.setAttribute('download', filename || 'fichier');
        a.target = '_blank';
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    }

    // Écouteurs
    const searchEl = document.getElementById('search');
    document.getElementById('refresh').addEventListener('click', loadPhotos);
    document.getElementById('reset').addEventListener('click', () => { searchEl.value = ''; render(); });

    // Recherche live — on multiplie les événements pour une compat max (desktop, iOS, champ “recherche”)
    searchEl.addEventListener('input', render);
    searchEl.addEventListener('keyup', render);
    searchEl.addEventListener('search', render); // déclenché quand on clique sur la croix du champ

    // Init
    loadPhotos();
  </script>
</body>
</html>
