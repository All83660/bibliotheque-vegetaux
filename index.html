<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bibliothèque de végétaux</title>
<style>
  :root{--border:#ddd;--muted:#666}
  body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f7f7f7;color:#222}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:12px;align-items:center;z-index:10;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;font-weight:600}
  .grow{flex:1;min-width:240px}
  input[type="search"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff}
  .wrap{max-width:1200px;margin:16px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,.05);overflow:hidden;display:flex;flex-direction:column}
  .card img{width:100%;height:180px;object-fit:cover;background:#fafafa}
  .meta{padding:10px;display:flex;flex-direction:column;gap:6px;flex:1}
  .title{font-weight:600;font-size:14px}
  .subtitle{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
  .btn{flex:1;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:#fafafa;font-size:12px;cursor:pointer}
  .btn:hover{background:#eee}
  #error{color:#b00;padding:16px}
  #counter{font-size:12px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>
<header>
  <h1>Bibliothèque de végétaux</h1>
  <div class="grow"><input id="q" type="search" placeholder="Rechercher..."></div>
  <button class="btn" id="refresh">Actualiser</button>
  <button class="btn" id="reset">Réinitialiser</button>
</header>

<div class="wrap">
  <div id="error"></div>
  <div id="grid" class="grid"></div>
  <div id="counter"></div>
</div>

<script>
/* ===== Config dépôt ===== */
const OWNER  = "All83660";
const REPO   = "bibliotheque-vegetaux";
const BRANCH = "main";
const FOLDER = "photos"; // ton dossier d'images
/* ======================== */

/* On passe par l’API jsDelivr (pas de rate limit bloquante) */
async function listImagesViaJsDelivr() {
  // Liste les fichiers dans /photos
  const url = `https://data.jsdelivr.com/v1/package/gh/${OWNER}/${REPO}@${BRANCH}/files/${FOLDER}`;
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("jsDelivr n'a pas pu lister les fichiers (" + r.status + ")");
  const data = await r.json();
  const items = Array.isArray(data) ? data : (data.files || []);
  // Ne garder que les fichiers images à la racine de /photos
  return items
    .filter(x => x.type === "file" && /\.(jpe?g|png|gif|webp)$/i.test(x.name))
    .map(x => ({
      name: x.name,
      // URL CDN pour afficher/télécharger le fichier
      url: `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@${BRANCH}/${FOLDER}/${encodeURIComponent(x.name)}`
    }));
}

/* ----------- UI / rendu ----------- */
const GRID = document.getElementById("grid");
const ERR  = document.getElementById("error");
const Q    = document.getElementById("q");
const COUNTER = document.getElementById("counter");
let ALL = [];

function normalize(str){
  return str.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]/g,"");
}

function makeCard(item){
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.nom = item.name.replace(/\.[^.]+$/,"").toLowerCase();
  card.innerHTML = `
    <img src="${item.url}" alt="">
    <div class="meta">
      <div class="title">${item.name.replace(/\.[^.]+$/,"")}</div>
      <div class="row">
        <a class="btn" href="${item.url}" target="_blank" rel="noreferrer">Ouvrir</a>
        <button class="btn copy">Copier lien</button>
        <button class="btn dl">Télécharger</button>
      </div>
    </div>`;
  // copier / télécharger (sans inline JS pour éviter les soucis d'apostrophes)
  card.querySelector(".copy").addEventListener("click", () =>
    navigator.clipboard.writeText(item.url)
  );
  card.querySelector(".dl").addEventListener("click", () => downloadFile(item.url, item.name));
  return card;
}

async function downloadFile(url, filename){
  const res = await fetch(url, { cache: "no-store" });
  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename || "image.jpg";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
}

function applySearch(){
  const nq = normalize(Q.value);
  let visible = 0;
  document.querySelectorAll("#grid .card").forEach(c=>{
    const show = normalize(c.dataset.nom).includes(nq);
    c.hidden = !show;
    if (show) visible++;
  });
  COUNTER.textContent = `${visible}/${ALL.length} visibles`;
}

async function render(){
  GRID.textContent = "Chargement…";
  ERR.textContent = "";
  try {
    ALL = await listImagesViaJsDelivr();
    GRID.innerHTML = "";
    ALL.forEach(it => GRID.appendChild(makeCard(it)));
    applySearch();
  } catch (e) {
    GRID.innerHTML = "";
    ERR.textContent = "Erreur: " + e.message;
  }
}

/* événements */
Q.addEventListener("input", applySearch);
document.getElementById("refresh").addEventListener("click", render);
document.getElementById("reset").addEventListener("click", ()=>{ Q.value=""; applySearch(); });

render();
</script>
</body>
</html>
